# 2.9 VPC μ—”λ“ν¬μΈνΈλ¥Ό μ‚¬μ©ν• S3 μ ‘κ·Ό

> _S3μ© VPC μ—”λ“ν¬μΈνΈλ¥Ό μ‚¬μ©ν•μ—¬ VPC λ‚΄μ λ¦¬μ†μ¤ λ€μ—­ν­ λΉ„μ©μ„ λ‚®κ² μ μ§€ν•λ©΄μ„ λ³΄μ•μ„ μ„ν•΄ μΈν„°λ„·μ„ μ‚¬μ©ν•μ§€ μ•κ³  νΉμ • S3 λ²„ν‚·μ— μ ‘κ·Όν•  μ μλ‹¤_

#### β‘  VPCμ— κ²μ΄νΈμ›¨μ΄ μ—”λ“ν¬μΈνΈλ¥Ό μƒμ„±ν•κ³  λΌμ°ν… ν…μ΄λΈ”κ³Ό μ—°κ²°

```bash
ENDPOINT_ID=$(aws ec2 create-vpc-endpoint \
	--vpc-id $VPC_ID \
	--service-name com.amazonaws.$AWS_REGION.s3 \
	--route-table-ids $RT_ID_1 $RT_ID_2 \
	--query VpcEndpoint.VpcEndpointId --output text)
```

#### β‘΅ νΉμ • S3 λ²„ν‚·μΌλ΅λ§ μ ‘κ·Όμ„ μ ν•ν•λ” μ—”λ“ν¬μΈνΈ μ •μ±… νμΌμ„ μƒμ„± ; `policy-template.json`

```json
{
  "Statement": [
    {
      "Sid": "RestrictToOneBucket",
      "Principal": "*",
      "Action": ["s3:GetObject", "s3:PutObject"],
      "Effect": "Allow",
      "Resource": ["arn:aws:s3:::S3BucketName", "arn:aws:s3:::S3BucketName/*"]
    }
  ]
}
```

#### β‘Ά `S3BucketName`κ°’μ„ μΉν™ν•μ—¬ `policy.json` μƒμ„±

```bash
sed -e "s/S3BucketName/${BUCKET_NAME}/g" \
	policy-template.json > policy.json
```

#### β‘£ μ—”λ“ν¬μΈνΈ μ •μ±…μ„ μ‚¬μ©ν•μ—¬ VPC μ—”λ“ν¬μΈνΈλ¥Ό ν†µν•΄ μ•΅μ„Έμ¤ν•  μ μλ” λ¦¬μ†μ¤ μ ν•

```bash
aws ec2 modify-vpc-endpoint \
	--policy-document file://policy.json \
	--vpc-endpoint-id $ENDPOINT_ID
```

---

**π¥•Β μ ν¨μ„± κ²€μ‚¬** : S3 λ²„ν‚· μ ‘κ·Ό κ°€λ¥ μ—¬λ¶€ ν™•μΈ

```bash
# S3 λ²„ν‚· μ΄λ¦„ ν™•μΈ
echo $BUCKET_NAME

# μΈμ¤ν„΄μ¤ μ—°κ²°
aws ssm start-session --target $INSTANCE_ID

# μΈμ¤ν„΄μ¤ λ©”νƒ€λ°μ΄ν„° κ°’μΌλ΅ λ¦¬μ „ μ„¤μ •
export AWS_DEFAULT_REGION=$(curl \
	--silent http://169.254.169.254/latest/dynamic/instance-identity/document \
	| awk -F'"' ' /region/ {print $4}')

# μ •μ±…μ— μ‚¬μ©ν• S3 λ²„ν‚· μ΄λ¦„ λ¶λ¬μ¤κΈ°
BUCKET=$(aws ssm get-parameters \
	--names "Cookbook209S3Bucket" \
	--query "Parameters[*].Value" --output text)

# S3 λ²„ν‚·μ νμΌμ„ λ³µμ‚¬ν•΄ μ ‘κ·Όμ΄ κ°€λ¥ν•μ§€ ν™•μΈ
aws s3 cp s3://${BUCKET_NAME}/test_file /home/ssm-user/

# ssm μΆ…λ£
exit
```

**π¥•Β μ°Έκ³ **

βΆ μ—”λ“ν¬μΈνΈ μ •μ±…

- S3 λ²„ν‚·μ— λ€ν• μ•΅μ„Έμ¤λ¥Ό μ ν•ν•κΈ° μ„ν•΄ μ‚¬μ©
- κ³„μ • μ†μ  λ²„ν‚·λΏλ§ μ•„λ‹λΌ AWSμ λ¨λ“  S3 λ²„ν‚·μ—λ„ μ μ© κ°€λ¥

βΆ κ²μ΄νΈμ›¨μ΄ VPC μ—”λ“ν¬μΈνΈλ” λ¬΄λ£, μΈν„°λ„·μ„ ν†µκ³Όν•μ§€ μ•κ³  AWS λ°±λ³Έ λ„¤νΈμ›ν¬ λ‚΄μ—μ„ νΈλν”½ μ μ§€

- S3, DynamoDBμ™€ κ°™μ€ λ‹¤λ¥Έ μ„λΉ„μ¤μ— μ•΅μ„Έμ¤ν•λ” μ• ν”λ¦¬μΌ€μ΄μ…μ΄ IGW μ—†μ΄ μ ‘κ·Ό κ°€λ¥
