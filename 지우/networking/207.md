# 2.7 ALBë¥¼ ì‚¬ìš©í•´ HTTP íŠ¸ë˜í”½ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜

> _í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ êµ¬ë™ ì¤‘ì¸ ì»¨í…Œì´ë„ˆí™”ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ HTTPì˜ ëª¨ë“  ìš”ì²­ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜_

#### â‘  ì¸ì¦ì„œì— ì‚¬ìš©í•  ê°œì¸í‚¤ì™€ ACMìœ¼ë¡œ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œ ìƒì„± & IAM ì—…ë¡œë“œ

```bash
# ê°œì¸í‚¤
openssl genrsa 2048 > my-private-key.pem

# ACM ì¸ì¦ì„œ
openssl req -new -x509 -nodes -sha256 -days 365 \
	-key my-private-key -outform PEM -out my-certificate.pem

# IAMì— ì—…ë¡œë“œ
CERT_ARN=$(aws iam upload-server-certificate \
	--server-certificate-name AWSCookbookCert \
	--certificate-body file://my-certificate.pem \
	--private-key file://my-private-key.pem \
	--query ServerCertificateMetadata.Arn --output text)
```

#### â‘¡ ALBì— ì‚¬ìš©í•  ë³´ì•ˆ ê·¸ë£¹ ìƒì„± & HTTP ë° HTTPS íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ëŠ” ê·œì¹™ ì¶”ê°€

```bash
ALB_SG_ID=$(aws ec2 create-security-group \
	--group-name ALB_SG \
	--description "security group for ALB" --vpc-id $VPC_ID \
	--output text --query GroupId)

# inbound ingress
aws ec2 authorize-security-group ingress \
	--protocol tcp --port 443 \
	--cidr '0.0.0.0/0'
	--group-id $ALB_SG_ID

aws ec2 authorize-security-group ingress \
	--protocol tcp --port 80 \
	--cidr '0.0.0.0/0'
	--group-id $ALB_SG_ID
```

#### â‘¢ ALB íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ë„ë¡ ì»¨í…Œì´ë„ˆì˜ ë³´ì•ˆ ê·¸ë£¹ì— ê¶Œí•œ ë¶€ì—¬

```bash
aws ec2 authorize-security-group-ingress \
	--protocol tcp --port 80 \
	--source-group $ALB_SG_ID \
	--group-id $APP_SG_ID
```

#### â‘£ í¼ë¸”ë¦­ ì„œë¸Œë„·ì— ALB ìƒì„±í•˜ê³  ë³´ì•ˆ ê·¸ë£¹ ì—°ê²°

```bash
LB_ARN=$(aws elbv2 create-load-balancer \
	--name AWSCookbook207-alb \
	--subnets $VPC_PUBLIC_SUBNETS --security-groups $ALB_SG_ID \
	--scheme internet-facing \
	--output text --query LoadBalancers[0].LoadBalancerArn)

```

#### â‘¤ ëŒ€ìƒ ê·¸ë£¹ ìƒì„± & ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì»¨í…Œì´ë„ˆ IP í™•ì¸í•˜ì—¬ ëŒ€ìƒ ê·¸ë£¹ì— ë“±ë¡

- ECS ì„œë¹„ìŠ¤ ë‚´ ECS íƒœìŠ¤í¬ì˜ IP ë“±ë¡

```bash
# ëŒ€ìƒ ê·¸ë£¹ ìƒì„±
TARGET_GROUP=$(aws elbv2 create-target-group \
	--name aws-cookbook207-tg --vpc-id $VPC_ID \
	--protocol HTTP --port 80 --target-type ip \
	--query "TargetGroups[0].TargetGroupArn" \
	--output text)

# ì»¨í…Œì´ë„ˆ IP í™•ì¸
TASK_ARN=$(aws ecs list-tasks --cluster $ECS_CLUSTER_NAME \
	--output text --query taskArns)

CONTAINER_IP=$(aws ecs describe-tasks --cluster $ECS_CLUSTER_NAME \
	--task $TASK_ARN --output text \
	--query tasks[0].attachments[0].details[4] | cut -f 2)

# ëŒ€ìƒ ê·¸ë£¹ì— ë“±ë¡
aws elbv2 register-targets --targets Id=$CONTAINER_IP \
	--target-group-arn $TARGET_GROUP
```

#### â‘¥ ì•ì„œ ìƒì„±í•œ ì¸ì¦ì„œë¡œ ë¦¬ìŠ¤ë„ˆì™€ ë¦¬ìŠ¤ë„ˆ ê·œì¹™ ìƒì„±

- ë¦¬ìŠ¤ë„ˆëŠ” íŠ¸ë˜í”½ì„ ëŒ€ìƒ ê·¸ë£¹ì— ì „ë‹¬í•˜ëŠ” ê¸°ëŠ¥
- í¬íŠ¸ 443ì˜ ë¦¬ìŠ¤ë„ˆ ê·œì¹™ì„ ì¶”ê°€

```bash
# ë¦¬ìŠ¤ë„ˆ ìƒì„±
HTTPS_LISTENER_ARN=$(aws elbv2 create-listener \
	--load-balancer-arn $LB_ARN \
	--protocol HTTPS --port 443 \
	--certificates CertificateArn=$CERT_ARN \
	--default-actions Type=forward,TargetGroupArn=$TARGET_GROUP \
	--output text --query Listeners[0].ListenerArn)

# ë¦¬ìŠ¤ë„ˆ ê·œì¹™ ì¶”ê°€
aws elbv2 create-rule \
	--listener-arn $HTTPS_LISTENER_ARN \
	--priority 10 \
	--conditions '{"Field":"path-pattern","PathPatternConfig":{"Values":["/*"]}}' \
	--actions Type=forward,TargetGroupArn=$TARGET_GROUP
```

#### â‘¦ HTTPS ë¦¬ë””ë ‰ì…˜ì— ëŒ€í•œ ì „ì²´ URLì„ ìœ ì§€í•˜ë©´ì„œ ë¸Œë¼ìš°ì €ì— 301 ì‘ë‹µì„ ë³´ë‚´ëŠ” ëª¨ë“  HTTP íŠ¸ë˜í”½ì— ë¦¬ë””ë ‰ì…˜ ìƒì„±

```bash
aws elbv2 create-listener --load-balancer-arn $LB_ARN \
	--protocol HTTP --port 80 \
	--default-actions \
"Type=redirect,RedirectConfig={Protocol=HTTPS,Port=443,Host='#{host}',Query='#{query}',Path='/#{path}',StatusCode=HTTP_301}"
```

#### â‘§ ëŒ€ìƒ ìƒíƒœ í™•ì¸

```bash
aws elbv2 describe-target-health --target-group-arn $TARGET_GROUP \
	--query TargetHealthDescriptions[*].TargetHealth.State
```

---

**ğŸ¥•Â ìœ íš¨ì„± ê²€ì‚¬** : echo ë˜ëŠ” curlë¡œ URL í…ŒìŠ¤íŠ¸

```bash
# ë¡œë“œë°¸ëŸ°ì„œ DNS
LB_DNS=$(aws elbv2 describe-load-balancers \
	--names AWSCookbook207-alb \
	--output text --query LoadBlanacers[0].DNSName)

# URL test
echo $LB_DNS
curl -v http://$LB_DNS

# HTTPS ë¦¬ë””ë ‰ì…˜ ì§€ì •
curl -vkL http://$LB_DNS
```

**ğŸ¥•Â ì°¸ê³ **

â¢ í¬íŠ¸ 80 ë¦¬ìŠ¤ë„ˆì— 301 ë¦¬ë””ë ‰ì…˜ ê·œì¹™ì„ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ì ìš”ì²­ì´ í¬íŠ¸ 443ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë˜ë„ë¡ êµ¬ì„±

- ë¦¬ë””ë ‰ì…˜ ê·œì¹™ì€ ì›ë˜ ìš”ì²­ì˜ URL ê²½ë¡œë„ ìœ ì§€

â¢ ALBëŠ” OSI 7ê³„ì¸µì—ì„œ ì‘ë™

- internet-facing, internalì˜ ë‘ ê°€ì§€ ìœ í˜•ì´ ìˆìŒ
- ì„œë¹„ìŠ¤ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ ì„ íƒí•œ ì„œë¸Œë„· ë‚´ì— IP ì£¼ì†Œë¥¼ ê°€ì§„ ENIë¥¼ í”„ë¡œë¹„ì €ë‹í•¨
- ì§€ì†ì ì¸ health check
- ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µê³¼ì˜ ê²©ë¦¬
- ìš”êµ¬ ì‚¬í•­ì— ë”°ë¼ ê³ ì • IPë¥¼ ê°–ëŠ” NLBë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŒ
- ê°€ìƒ ë°©í™”ë²½ ë° ë³´ì•ˆ ì–´í”Œë¼ì´ì–¸ìŠ¤ì™€ ê°™ì€ NVAì˜ ê²½ìš°, ê²Œì´íŠ¸ì›¨ì´ ë¡œë“œ ë°¸ëŸ°ì„œ ê³ ë ¤
