# 2.10 Transit Gatewayë¥¼ ì‚¬ìš©í•´ ì „ì´ ë¼ìš°íŒ… ì—°ê²° í™œì„±í™”

> _NAT ê²Œì´íŠ¸ì›¨ì´ ìˆ˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ëª¨ë“  VPCì— ì „ì´ ë¼ìš°íŒ…ì„ ì ìš©í•˜ê³  ì™¸ë¶€ ì¸í„°ë„· íŠ¸ë˜í”½ì„ í•˜ë‚˜ì˜ ê³µìœ  ì„œë¹„ìŠ¤ VPCë¥¼ í†µí•´ ì‚¬ìš©í•œë‹¤_

- TGW ë°°í¬, ëª¨ë“  VPCì— ëŒ€í•œ ì „ì†¡ ê²Œì´íŠ¸ì›¨ì´ VPC ì—°ê²°ì„ êµ¬ì„±
- ê° VPCì˜ ì™¸ë¶€ íŠ¸ë˜í”½ì„ TGWë¡œ ë³´ë‚´ë„ë¡ ì„¤ì •â†’ ëª¨ë“  ìŠ¤í¬í¬ VPCê°€ ê³µìœ  ì„œë¹„ìŠ¤ VPCì˜ NGWë¥¼ ì‚¬ìš©

<img src="https://user-images.githubusercontent.com/70079416/222085321-c586fd04-18a0-4ab5-93a8-a73b1cb6f603.png" width="60%" height="60%" />

#### â‘  TGW ìƒì„±í•˜ê³  ìƒíƒœê°€ `available`ë¡œ ë³€ê²½ë  ë•Œê¹Œì§€ ëŒ€ê¸°

```bash
# transit gateway ìƒì„±
TGW_ID=$(aws ec2 create-transit-gateway \
	--description AWSCookbook210 \
	--options=AmazonSideAsn=65010,AutoAcceptSharedAttachments=enable,DefaultRouteTableAssociation=enable, \
	DefaultRouteTablePropagation=enable,VpnEcmpSupport=enable,DnsSupport=enable \
	--output text --query TransitGateway.TransitGatewayId)

# status check
aws ec2 describe-transit-gateways \
	--transit-gateway-ids $TGW_ID \
	--output text --query TransitGateways[0].State
```

#### â‘¡ VPC1, VPC2, VPC3ì— ì „ì†¡ ê²Œì´íŠ¸ì›¨ì´ ì—°ê²° ìƒì„±

```bash
# VPC1
TGW_ATTACH_1=$(aws ec2 create-transit-gateway-vpc-attachment \
	--transit-gateway-id $TGW_ID \
	--vpc-id $VPC_ID_1 \
	--subnet-ids $ATTACHMENT_SUBNETS_VPC_1 \
	--query TransitGatewayVpcAttachment.TransitGatewayAttachmentId \
	--output text)

# VPC2
TGW_ATTACH_2=$(aws ec2 create-transit-gateway-vpc-attachment \
	--transit-gateway-id $TGW_ID \
	--vpc-id $VPC_ID_2 \
	--subnet-ids $ATTACHMENT_SUBNETS_VPC_2 \
	--query TransitGatewayVpcAttachment.TransitGatewayAttachmentId \
	--output text)

# VPC3
TGW_ATTACH_3=$(aws ec2 create-transit-gateway-vpc-attachment \
	--transit-gateway-id $TGW_ID \
	--vpc-id $VPC_ID_3 \
	--subnet-ids $ATTACHMENT_SUBNETS_VPC_3 \
	--query TransitGatewayVpcAttachment.TransitGatewayAttachmentId \
	--output text)
```

#### â‘¢ ê° VPCì˜ ì„œë¸Œë„·ì— ê²½ë¡œ ì„¤ì •

â¢ VPC1ê³¼ VPC3ì˜ ëª¨ë“  í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— 0.0.0.0/0ì— ëŒ€í•œ ê²½ë¡œë¥¼ TGWë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¶”ê°€

- ë‹¤ë¥¸ VPCì˜ ì¸í„°ë„· íŠ¸ë˜í”½ì„ VPC2ì˜ NAT ê²Œì´íŠ¸ì›¨ì´ë¥¼ í†µí•´ ì „ì´ ë¼ìš°íŒ…ì´ ê°€ëŠ¥í•´ì§

```bash
# VPC1
aws ec2 create-route --route-table-id $VPC1_RT_ID_1 \
	--destination-cidr-block 0.0.0.0/0 \
	--transit-gateway-id $TGW_ID

aws ec2 create-route --route-table-id $VPC1_RT_ID_2 \
	--destination-cidr-block 0.0.0.0/0 \
	--transit-gateway-id $TGW_ID

# VPC3
aws ec2 create-route --route-table-id $VPC3_RT_ID_1 \
	--destination-cidr-block 0.0.0.0/0 \
	--transit-gateway-id $TGW_ID

aws ec2 create-route --route-table-id $VPC3_RT_ID_2 \
	--destination-cidr-block 0.0.0.0/0 \
	--transit-gateway-id $TGW_ID
```

â¢ VPC2ì˜ í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ì—°ê²°ëœ ë¼ìš°íŒ… í…Œì´ë¸”ì— 10.10.0.0/24 ìŠˆí¼ë„·ì— ëŒ€í•œ ê²½ë¡œë¥¼ ì¶”ê°€í•˜ì—¬ ëŒ€ìƒì´ ì „ì†¡ ê²Œì´íŠ¸ì›¨ì´ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ì„¤ì •

- ë” êµ¬ì²´ì ì¸ ê²½ë¡œë¥¼ ê°–ê¸° ë•Œë¬¸ì— ìš°ì„ ì ì¸ ë¼ìš°íŒ… ìˆœìœ„ë¥¼ ê°€ì§

```bash
aws ec2 create-route --route-table-id $VPC2_RT_ID_1 \
	--destination-cidr-block 10.10.0.0/24 \
	--transit-gateway-id $TGW_ID

aws ec2 create-route --route-table-id $VPC2_RT_ID_2 \
	--destination-cidr-block 10.10.0.0/24 \
	--transit-gateway-id $TGW_ID
```

#### â‘£ ì‚¬ìš© ì¤‘ì¸ NAT ê²Œì´íŠ¸ì›¨ì´ ì •ë³´ë¥¼ ê°€ì ¸ì™€ ì¸í„°ë„· íŠ¸ë˜í”½ì— ëŒ€í•œ ê²½ë¡œë¥¼ ì¶”ê°€

```bash
# VPC2ì˜ public subnet 1
NGW_ID_1=$(aws ec2 describe-nat-gateways \
	--filter "Name=subnet-id,Values=$VPC2_PUBLIC_SUBNET_ID_1" \
	--output text --query NatGateways[*].NatGatewayId)

# VPC2ì˜ public subnet 1
NGW_ID_2=$(aws ec2 describe-nat-gateways \
	--filter "Name=subnet-id,Values=$VPC2_PUBLIC_SUBNET_ID_2" \
	--output text --query NatGateways[*].NatGatewayId)
```

#### â‘¤ ì¸í„°ë„· íŠ¸ë˜í”½ì„ NAT ê²Œì´íŠ¸ì›¨ì´ë¡œ ë³´ë‚´ê³ ì VPC2 ì„œë¸Œë„·ì— ëŒ€í•œ ê²½ë¡œë¥¼ ì¶”ê°€

```bash
aws ec2 create-route --route-table-id $VPC2_ATTACH_RT_ID_1 \
	--destination-cidr-block 0.0.0.0/0 \
	--nat-gateway-id $NGW_ID_1

aws ec2 create-route --route-table-id $VPC2_ATTACH_RT_ID_2 \
	--destination-cidr-block 0.0.0.0/0 \
	--nat-gateway-id $NGW_ID_2
```

#### â‘¥ VPC2ì— ê²½ë¡œ ì¶”ê°€

â¢ VPC2ì˜ í¼ë¸”ë¦­ ì„œë¸Œë„·ê³¼ ì—°ê²°ëœ ë¼ìš°íŒ… í…Œì´ë¸”ì— ê³ ì • ê²½ë¡œ ì¶”ê°€ â†’ ëª¨ë“  VPCì™€ NAT ê²Œì´íŠ¸ì›¨ì´ ê³µìœ  ê°€ëŠ¥

```bash
aws ec2 create-route --route-table-id $VPC2_PUBLIC_RT_ID_1 \
	--destination-cidr-block 10.10.0.0/24 \
	--transit-gateway-id $TGW_ID

aws ec2 create-route --route-table-id $VPC2_PUBLIC_RT_ID_2 \
	--destination-cidr-block 10.10.0.0/24 \
	--transit-gateway-id $TGW_ID
```

â¢ VPC2ì˜ í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ëŒ€í•œ ì •ì  ê²½ë¡œë¥¼ ì¶”ê°€ â†’ VPC2 í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ TGWë¡œ ë‹¤ì‹œ í†µì‹  ê°€ëŠ¥

```bash
aws ec2 create-route --route-table-id $VPC2_PRIVATE_RT_ID_1 \
	--destination-cidr-block 10.10.0.0/24 \
	--transit-gateway-id $TGW_ID

aws ec2 create-route --route-table-id $VPC2_PRIVATE_RT_ID_2 \
	--destination-cidr-block 10.10.0.0/24 \
	--transit-gateway-id $TGW_ID
```

#### â‘¦ TGW ë¼ìš°íŒ… í…Œì´ë¸”ì˜ IDë¥¼ ê°€ì ¸ì™€ì„œ ì´ ê²½ë¡œë¥¼ í†µí•´ ëª¨ë“  ì¸í„°ë„· íŠ¸ë˜í”½ì„ ë³´ë‚´ë„ë¡ VPC2ì˜ ì „ì†¡ ê²Œì´íŠ¸ì›¨ì´ì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì— ê³ ì • ê²½ë¡œë¥¼ ì¶”ê°€

```bash
TGW_RT=$(aws ec2 describe-transit-gateways \
	--transit-gateway-ids $TGW_ID --output text \
	--query TransitGateways[0].Options.AssociationDefaultRouteTableId)

# TGWì— ê³ ì • ê²½ë¡œ ì¶”ê°€
aws ec2 create-transit-gateway-route \
	--destination-cidr-block 0.0.0.0/0 \
	--transit-gateway-route-table-id $TGW_RT
	--transit-gateway-attachment-id $TGW_ATTACH_2
```

---

ğŸ¥•Â ì°¸ê³ 

â¢ **Transit Gateway**

- AWSì—ì„œ ë¹ ë¥´ê²Œ hub and spoke ë„¤íŠ¸ì›Œí¬ í† í´ë¡œì§€ êµ¬í˜„ ê°€ëŠ¥
- êµì°¨ ë¦¬ì „ í”¼ì–´ë§ ë° ë¦¬ì†ŒìŠ¤ ì•¡ì„¸ìŠ¤ ê´€ë¦¬ì(RAM)ë¥¼ í†µí•œ êµì°¨ ê³„ì • ê³µìœ ë¥¼ ì§€ì›

â¢ íƒ„ë ¥ì„±ì„ ìœ„í•´ ì „ìš© ì—°ê²° ì„œë¸Œë„·ì„ ì‚¬ìš©

- TGWë¡œ ë¼ìš°íŒ…í•˜ë ¤ëŠ” ì„œë¸Œë„·ì„ ì„¸ë¶€ì ìœ¼ë¡œ ì •ì˜ ê°€ëŠ¥í•œ ìœ ì—°ì„±ì´ ë³´ì¥ë¨

â¢ ê° VPCì— NAT ê²Œì´íŠ¸ì›¨ì´ë¥¼ ë°°í¬í•˜ëŠ” ê²ƒë³´ë‹¤ ë¹„ìš© ì ˆê°

- NGWì™€ IGWì˜ ê³µìœ ë¥¼ í™œì„±í™”í•œ Transit Gatewayë¡œ ëª¨ë“  íŠ¸ë˜í”½ì„ ë³´ë‚´ë„ë¡ í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ëŒ€í•œ ê²½ë¡œë¥¼ êµ¬ì„±í–ˆê¸° ë•Œë¬¸
