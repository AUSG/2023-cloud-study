# 3. RDS 프록시를 사용한 람다와 RDS 연결

### 실습

---

서버리스 함수(=람다)가 관계형 데이터베이스에 연결할 때 연결 수를 최소화하고 성능을 향상시키고자 커넥션 풀링을 사용해야한다.

> **Connection-pooling?**

- 일반적으로 데이터베이스 연결은 비용이 큰 작업이기 때문에, 매번 데이터베이스에 접속하여 연결을 생성하고 종료하는 것은 시간과 자원 낭비가 됩니다.
- 이를 해결하기 위해 **커넥션 풀링은 미리 설정된 여러 개의 데이터베이스 연결을 생성하여 유지하고, 필요할 때 이러한 연결을 가져와 사용**합니다.
  >

<br>

이를 위해, RDS 프록시를 생성하고 이를 RDS MySQL 데이터베이스와 연결한다. 람다가 데이터베이스에 직접 액세스하는 대신 프록시에 연결하도록 구성한다.

> **RDS Proxy?**

- Amazon RDS 데이터베이스 인스턴스에 대한 확장 가능하고 안정적인 데이터베이스 연결 프록시
- 클라이언트 애플리케이션과 Amazon RDS 데이터베이스 인스턴스 간의 연결을 중재하며, 데이터베이스 연결을 관리하고 더 높은 성능과 안정성을 제공
- Amazon RDS 인스턴스의 스케일링 작업과 관련된 작업을 자동화하여, 데이터베이스 성능과 가용성을 최적화
- 데이터베이스 연결 풀링, 스크립트 실행 및 데이터베이스 로깅과 같은 기능을 제공
  >

<br>

1. RDS 프록시에 대한 IAM 역할을 생성
2. RDS 프록시에서 사용할 보안 그룹을 생성
3. RDS 프록시 생성 (사용할 수 있을 때까지 기다리기 → RDS 프록시 앤드포인트 저장)
4. 람다 함수가 IAM 인증 토큰을 생성할 수 있는 권한을 가진 IAM 정책을 생성
5. IAM 정책을 구성하는데 필요한 프록시 ID 구하기 (RDS 프록시 앤드포인트 ARN에서 프록시 ID를 분리)
6. IAM 정책 생성
7. 정책을 DBAppFunction 람다 함수의 역할에 연결 (프록시가 사용할 수 있는 상태가 된 것을 확인한 다음 진행)
8. SecretsManagerReadWrite 정책을 RDS 프록시 역할에 연결 (SSM 관리자 권한 부여를 위해)
9. RDS 프록시 보안 그룹이 RDS 인스턴스의 보안그룹의 TCP 포트 3306(기본 MySQL TCP 포트)에 대한 액세스를 허용하는 수신 규칙(ingress)을 추가한다.
10. RDS 프록시에 대상을 등록한다.
11. 대상 등록상태가 Availiable 로 변할 떄까지 기다린다.
12. 람다 함수의 보안그룹이 RDS 프록시 보안 그룹의 TCP 포트 3306에 대한 액세스를 허용하는 수신 규칙을 추가한다.
13. 이제 **데이터베이스에 직접 연결하지 않고 RDS 프록시 엔드포인트를 DB_HOST로 사용하도록 람다함수를 수정**

<Br>
<br>

### 정리

---

- **RDS와 람다를 사용할 때 커넥션 풀링을 고려**해야한다.
- **RDS 프록시를 사용해 데이터베이스에 대한 연결을 관리하면 실제 데이터베이스에 대한 연결을 적게 유지할 수 있어 성능과 효율성을 높일 수 있다.**
- RDS 프록시를 사용하지 않으면 함수가 호출될 때마다 람다 함수가 데이터베이스에 대한 새 연결을 설정해야하고, 이 동작의 동시성이 높은 경우 데이터베이스에 대한 많은 양의 TCP 연결이 발생해 데이터베이스 성능이 저하되고 대기 시간이 증가할 수 있다.
- **RDS 프록시는 연결을 “POOL”로 관리해 람다의 연결을 관리하는데 도움이 된다.**
  - RDS 프록시를 "풀 관리"로 관리한다는 것은 프록시가 클라이언트 연결을 자동으로 관리하고, 연결을 재사용하여 성능을 최적화하려는 것을 의미
  - 클라이언트 요청이 프록시에 도달하면, 프록시가 해당 요청에 대한 연결을 풀에 추가하고, 연결 풀에서 사용 가능한 연결이 있는지 확인합니다. 만약 사용 가능한 연결이 있다면, 프록시는 해당 연결을 사용하여 클라이언트 요청을 처리합니다. 연결이 사용되면, 프록시는 연결을 풀에 반환하여 재사용할 수 있도록 만듭니다.
- 따라서 동시성이 증가하면 RDS 프록시가 데이터베이스에 대한 실제 연결을 필요한 만큼 늘리고 TCP 오버헤드를 RDS 프록시로 오프로드 한다.
